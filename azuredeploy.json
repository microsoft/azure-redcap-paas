{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.7.4.23292",
      "templateHash": "16250090929552356588"
    }
  },
  "parameters": {
    "siteName": {
      "type": "string",
      "metadata": {
        "description": "Name of azure web app"
      }
    },
    "linuxFxVersion": {
      "type": "string",
      "defaultValue": "php|7.4",
      "metadata": {
        "description": "Stack settings"
      }
    },
    "administratorLogin": {
      "type": "string",
      "defaultValue": "redcap_app",
      "minLength": 1,
      "metadata": {
        "description": "Database administrator login name"
      }
    },
    "administratorLoginPassword": {
      "type": "secureString",
      "minLength": 8,
      "metadata": {
        "description": "Database administrator password"
      }
    },
    "redcapAppZip": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "REDCap zip file URI."
      }
    },
    "redcapCommunityUsername": {
      "type": "string",
      "metadata": {
        "description": "REDCap Community site username for downloading the REDCap zip file."
      }
    },
    "redcapCommunityPassword": {
      "type": "secureString",
      "metadata": {
        "description": "REDCap Community site password for downloading the REDCap zip file."
      }
    },
    "redcapAppZipVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "REDCap zip file version to be downloaded from the REDCap Community site."
      }
    },
    "fromEmailAddress": {
      "type": "string",
      "metadata": {
        "description": "Email address configured as the sending address in REDCap"
      }
    },
    "smtpFQDN": {
      "type": "string",
      "metadata": {
        "description": "Fully-qualified domain name of your SMTP relay endpoint"
      }
    },
    "smtpUser": {
      "type": "string",
      "metadata": {
        "description": "Login name for your SMTP relay"
      }
    },
    "smtpPassword": {
      "type": "secureString",
      "metadata": {
        "description": "Login password for your SMTP relay"
      }
    },
    "smtpPort": {
      "type": "string",
      "defaultValue": "587",
      "metadata": {
        "description": "Port for your SMTP relay"
      }
    },
    "skuName": {
      "type": "string",
      "defaultValue": "S1",
      "allowedValues": [
        "F1",
        "D1",
        "B1",
        "B2",
        "B3",
        "S1",
        "S2",
        "S3",
        "P1v2",
        "P2v2",
        "P3v2",
        "P1v3",
        "P2v3",
        "P3v3"
      ],
      "metadata": {
        "description": "Describes plan's pricing tier and capacity - this can be changed after deployment. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/"
      }
    },
    "skuCapacity": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "metadata": {
        "description": "Describes plan's instance count (how many distinct web servers will be deployed in the farm) - this can be changed after deployment"
      }
    },
    "databaseSkuSizeMB": {
      "type": "int",
      "defaultValue": 5120,
      "metadata": {
        "description": "Azure database for MySQL sku Size "
      }
    },
    "databaseForMySqlTier": {
      "type": "string",
      "defaultValue": "GeneralPurpose",
      "allowedValues": [
        "Basic",
        "GeneralPurpose",
        "MemoryOptimized"
      ],
      "metadata": {
        "description": "Select MySql server performance tier. Please review https://docs.microsoft.com/en-us/azure/mysql/concepts-pricing-tiers and ensure your choices are available in the selected region."
      }
    },
    "databaseForMySqlFamily": {
      "type": "string",
      "defaultValue": "Gen5",
      "allowedValues": [
        "Gen4",
        "Gen5"
      ],
      "metadata": {
        "description": "Select MySql compute generation. Please review https://docs.microsoft.com/en-us/azure/mysql/concepts-pricing-tiers and ensure your choices are available in the selected region."
      }
    },
    "databaseForMySqlCores": {
      "type": "int",
      "defaultValue": 2,
      "allowedValues": [
        1,
        2,
        4,
        8,
        16,
        32
      ],
      "metadata": {
        "description": "Select MySql vCore count. Please review https://docs.microsoft.com/en-us/azure/mysql/concepts-pricing-tiers and ensure your choices are available in the selected region."
      }
    },
    "mysqlVersion": {
      "type": "string",
      "defaultValue": "5.7",
      "allowedValues": [
        "5.6",
        "5.7"
      ],
      "metadata": {
        "description": "MySQL version"
      }
    },
    "storageType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "The default selected is 'Locally Redundant Storage' (3 copies in one region). See https://docs.microsoft.com/en-us/azure/storage/common/storage-redundancy for more information."
      }
    },
    "storageContainerName": {
      "type": "string",
      "defaultValue": "redcap",
      "metadata": {
        "description": "Name of the container used to store backing files in the new storage account. This container is created automatically during deployment."
      }
    },
    "repoURL": {
      "type": "string",
      "defaultValue": "https://github.com/vanderbilt-redcap/redcap-azure.git",
      "metadata": {
        "description": "The path to the deployment source files on GitHub"
      }
    },
    "branch": {
      "type": "string",
      "defaultValue": "master",
      "metadata": {
        "description": "The main branch of the application repo"
      }
    }
  },
  "variables": {
    "siteName_var": "[replace(parameters('siteName'), ' ', '')]",
    "databaseName": "[format('{0}_db', variables('siteName_var'))]",
    "serverName_var": "[format('{0}{1}', variables('siteName_var'), uniqueString(resourceGroup().id))]",
    "hostingPlanName_var": "[format('{0}_serviceplan', variables('siteName_var'))]",
    "webSiteName_var": "[format('{0}{1}', variables('siteName_var'), uniqueString(resourceGroup().id))]",
    "tierSymbol": {
      "Basic": "B",
      "GeneralPurpose": "GP",
      "MemoryOptimized": "MO"
    },
    "databaseForMySqlSku": "[format('{0}_{1}_{2}', variables('tierSymbol')[parameters('databaseForMySqlTier')], parameters('databaseForMySqlFamily'), parameters('databaseForMySqlCores'))]",
    "storageName_var": "[format('storage{0}', uniqueString(resourceGroup().id))]",
    "storageAccountId": "[format('{0}/providers/Microsoft.Storage/storageAccounts/{1}', resourceGroup().id, variables('storageName_var'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2016-01-01",
      "name": "[variables('storageName_var')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "[parameters('storageType')]"
      },
      "tags": {
        "displayName": "BackingStorage"
      },
      "kind": "Storage"
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}/{1}', variables('storageName_var'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName_var'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}/{1}/{2}', variables('storageName_var'), 'default', parameters('storageContainerName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageName_var'), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2016-09-01",
      "name": "[variables('hostingPlanName_var')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "HostingPlan"
      },
      "sku": {
        "name": "[parameters('skuName')]",
        "capacity": "[parameters('skuCapacity')]"
      },
      "kind": "linux",
      "properties": {
        "name": "[variables('hostingPlanName_var')]",
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2016-08-01",
      "name": "[variables('webSiteName_var')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "WebApp"
      },
      "properties": {
        "name": "[variables('webSiteName_var')]",
        "serverFarmId": "[variables('hostingPlanName_var')]",
        "siteConfig": {
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "alwaysOn": true,
          "connectionStrings": [
            {
              "name": "defaultConnection",
              "connectionString": "[format('Database={0};Data Source={1}.mysql.database.azure.com;User Id={2}@{3};Password={4}', variables('databaseName'), variables('serverName_var'), parameters('administratorLogin'), variables('serverName_var'), parameters('administratorLoginPassword'))]",
              "type": "MySql"
            }
          ],
          "appCommandLine": "/home/startup.sh",
          "appSettings": [
            {
              "name": "StorageContainerName",
              "value": "[parameters('storageContainerName')]"
            },
            {
              "name": "StorageAccount",
              "value": "[variables('storageName_var')]"
            },
            {
              "name": "StorageKey",
              "value": "[concat(listKeys(variables('storageAccountId'), '2015-05-01-preview').key1)]"
            },
            {
              "name": "redcapAppZip",
              "value": "[parameters('redcapAppZip')]"
            },
            {
              "name": "redcapCommunityUsername",
              "value": "[parameters('redcapCommunityUsername')]"
            },
            {
              "name": "redcapCommunityPassword",
              "value": "[parameters('redcapCommunityPassword')]"
            },
            {
              "name": "redcapAppZipVersion",
              "value": "[parameters('redcapAppZipVersion')]"
            },
            {
              "name": "DBHostName",
              "value": "[format('{0}.mysql.database.azure.com', variables('serverName_var'))]"
            },
            {
              "name": "DBName",
              "value": "[variables('databaseName')]"
            },
            {
              "name": "DBUserName",
              "value": "[format('{0}@{1}', parameters('administratorLogin'), variables('serverName_var'))]"
            },
            {
              "name": "DBPassword",
              "value": "[parameters('administratorLoginPassword')]"
            },
            {
              "name": "PHP_INI_SCAN_DIR",
              "value": "/usr/local/etc/php/conf.d:/home/site"
            },
            {
              "name": "from_email_address",
              "value": "[parameters('fromEmailAddress')]"
            },
            {
              "name": "smtp_fqdn_name",
              "value": "[parameters('smtpFQDN')]"
            },
            {
              "name": "smtp_port",
              "value": "[parameters('smtpPort')]"
            },
            {
              "name": "smtp_user_name",
              "value": "[parameters('smtpUser')]"
            },
            {
              "name": "smtp_password",
              "value": "[parameters('smtpPassword')]"
            },
            {
              "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
              "value": "1"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName_var'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageName_var'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites/sourcecontrols",
      "apiVersion": "2015-08-01",
      "name": "[format('{0}/{1}', variables('webSiteName_var'), 'web')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "CodeDeploy"
      },
      "properties": {
        "repoUrl": "[parameters('repoURL')]",
        "branch": "[parameters('branch')]",
        "isManualIntegration": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforMySQL/servers', variables('serverName_var'))]",
        "[resourceId('Microsoft.Web/sites', variables('webSiteName_var'))]"
      ]
    },
    {
      "type": "Microsoft.DBforMySQL/servers",
      "apiVersion": "2017-12-01-preview",
      "name": "[variables('serverName_var')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "MySQLAzure"
      },
      "properties": {
        "version": "[parameters('mysqlVersion')]",
        "administratorLogin": "[parameters('administratorLogin')]",
        "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
        "storageProfile": {
          "storageMB": "[parameters('databaseSkuSizeMB')]",
          "backupRetentionDays": "7",
          "geoRedundantBackup": "Disabled"
        },
        "sslEnforcement": "Disabled"
      },
      "sku": {
        "name": "[variables('databaseForMySqlSku')]"
      }
    },
    {
      "type": "Microsoft.DBforMySQL/servers/firewallRules",
      "apiVersion": "2017-12-01-preview",
      "name": "[format('{0}/{1}', variables('serverName_var'), 'AllowAzureIPs')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforMySQL/servers', variables('serverName_var'))]",
        "[resourceId('Microsoft.DBforMySQL/servers/databases', variables('serverName_var'), format('{0}', variables('databaseName')))]"
      ]
    },
    {
      "type": "Microsoft.DBforMySQL/servers/databases",
      "apiVersion": "2017-12-01",
      "name": "[format('{0}/{1}', variables('serverName_var'), format('{0}', variables('databaseName')))]",
      "tags": {
        "displayName": "DB"
      },
      "properties": {
        "charset": "utf8",
        "collation": "utf8_general_ci"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforMySQL/servers', variables('serverName_var'))]"
      ]
    }
  ],
  "outputs": {
    "MySQLHostName": {
      "type": "string",
      "value": "[format('{0}.mysql.database.azure.com', variables('serverName_var'))]"
    },
    "MySqlUserName": {
      "type": "string",
      "value": "[format('{0}@{1}', parameters('administratorLogin'), variables('serverName_var'))]"
    },
    "webSiteFQDN": {
      "type": "string",
      "value": "[format('{0}.azurewebsites.net', variables('webSiteName_var'))]"
    },
    "storageAccountKey": {
      "type": "string",
      "value": "[concat(listKeys(variables('storageAccountId'), '2015-05-01-preview').key1)]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[variables('storageName_var')]"
    },
    "storageContainerName": {
      "type": "string",
      "value": "[parameters('storageContainerName')]"
    }
  }
}